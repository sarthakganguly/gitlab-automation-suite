<div class="table-responsive">
    <table class="table table-striped table-hover" id="epic-report-table">
        <thead>
            <tr>
                <th style="cursor: pointer;">Task (Issue Summary) <i class="bi bi-arrow-down-up"></i></th>
                <th style="cursor: pointer;">Assignees <i class="bi bi-arrow-down-up"></i></th>
                <th style="cursor: pointer;">Status <i class="bi bi-arrow-down-up"></i></th>
                <th style="cursor: pointer;">Created <i class="bi bi-arrow-down-up"></i></th>
                <th style="cursor: pointer;">Milestone Date <i class="bi bi-arrow-down-up"></i></th>
            </tr>
        </thead>
        <tbody>
        {% for issue in issues %}
            <tr>
                <td><a href="{{ issue.issue_url }}" target="_blank" title="{{ issue.Task }}">{{ issue.Task }}</a></td>
                <td>{{ issue.Assignees }}</td>
                <td>{{ issue.Status }}</td>
                <td>{{ issue.Created }}</td>
                <td>{{ issue['Milestone Date'] }}</td>
            </tr>
        {% else %}
            <tr><td colspan="5" class="text-center">No issues found for this epic.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // Defer execution to ensure the table is fully loaded in the DOM before attaching events.
    setTimeout(() => {
        const table = document.getElementById('epic-report-table');
        if (!table) return;

        let sortState = {
            column: 3, // Default sort by "Created" date
            direction: 'desc' // Default to newest first
        };

        const sortTable = (columnIndex) => {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            if (sortState.column === columnIndex) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = columnIndex;
                sortState.direction = 'asc';
            }

            rows.sort((a, b) => {
                const cellA = a.cells[columnIndex].textContent.trim();
                const cellB = b.cells[columnIndex].textContent.trim();
                
                let comparison = 0;
                if (columnIndex === 3 || columnIndex === 4) { // Date columns
                    const dateA = cellA === 'NA' ? new Date(0) : new Date(cellA);
                    const dateB = cellB === 'NA' ? new Date(0) : new Date(cellB);
                    if (dateA > dateB) comparison = 1;
                    if (dateA < dateB) comparison = -1;
                } else { // Text columns
                    comparison = cellA.localeCompare(cellB, undefined, {numeric: true});
                }

                return sortState.direction === 'asc' ? comparison : -comparison;
            });

            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        };

        // Add event listeners to headers
        table.querySelectorAll('thead th').forEach((header, index) => {
            header.addEventListener('click', () => {
                sortTable(index);
            });
        });

        // Initial sort on load
        sortTable(sortState.column);
    }, 0);
</script>
